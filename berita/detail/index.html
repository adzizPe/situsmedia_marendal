<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Berita - MarendalSatu</title>
    <link rel="icon" href="../../assets/388x388.png" type="image/x-icon">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/ai-chat.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body>
    <!-- Google One Tap -->
    <div id="g_id_onload" data-client_id="830162422312-5h3nq1bohtktfhg4ksodt0jjsbeuria9.apps.googleusercontent.com"
        data-callback="handleCredentialResponse" data-auto_prompt="false">
    </div>

    <!-- Live Visitor Counter -->
    <div class="visitor-counter" id="visitorCounter">
        <div class="visitor-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
        </div>
        <span class="visitor-count" id="visitorCount">0</span>
        <span class="visitor-label">visitors</span>
        <span class="visitor-live-dot"></span>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-top">
            <div class="container">
                <div class="logo">
                    <a href="../../">
                        <img src="../../assets/marendallogo.png" alt="MarendalSatu" class="logo-img">
                    </a>
                </div>
                <div class="header-right">
                    <div class="search-box">
                        <input type="text" placeholder="Cari berita...">
                        <button type="submit" title="Cari">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.3-4.3"></path>
                            </svg>
                        </button>
                    </div>
                    <!-- Auth Container -->
                    <div id="authContainer"></div>
                    <button type="button" class="theme-toggle" id="themeToggle" title="Ganti Tema">
                        <span class="theme-icon light">‚òÄÔ∏è</span>
                        <span class="theme-icon dark">üåô</span>
                    </button>
                    <div class="date-time">
                        <span id="current-date"></span>
                    </div>
                </div>
            </div>
        </div>

        <nav class="navbar">
            <div class="container">
                <ul class="nav-menu" id="navMenu">
                    <li class="nav-item"><a href="../../">BERANDA</a></li>
                    <li class="nav-item active"><a href="../../berita/">BERITA</a></li>
                    <li class="nav-item"><a href="../../umkm/">UMKM</a></li>
                    <li class="nav-item"><a href="../../event/">EVENT</a></li>
                    <li class="nav-item"><a href="../../kirim-berita/">KIRIM BERITA</a></li>
                    <li class="nav-item has-submenu">
                        <a href="../../quiz/">QUIZ BERITA</a>
                        <ul class="submenu">
                            <li><a href="../../quiz/">Quiz Harian</a></li>
                            <li><a href="../../quiz/leaderboard/">Papan Peringkat</a></li>
                        </ul>
                    </li>
                    <li class="nav-item"><a href="../../tentang-kami/">TENTANG KAMI</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Breadcrumb -->
            <div class="breadcrumb" id="breadcrumb">
                <a href="../">Berita</a> ‚Ä∫ <span id="breadcrumbCategory">Memuat...</span>
            </div>

            <div class="article-layout">
                <!-- Article Main -->
                <article class="article-main" id="articleMain">
                    <div class="article-loading">
                        <p>Memuat berita...</p>
                    </div>
                </article>

                <!-- Sidebar -->
                <aside class="sidebar">
                    <div class="sidebar-widget">
                        <div class="section-header">
                            <h3 class="section-title">Berita Terkait</h3>
                        </div>
                        <div class="related-list" id="relatedNews">
                            <p style="color: #888; font-size: 0.9rem;">Belum ada berita terkait.</p>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-main">
            <div class="container">
                <div class="footer-grid">
                    <div class="footer-brand">
                        <a href="../../"><img src="../../assets/marendallogo.png" alt="MarendalSatu" class="logo-img"></a>
                        <p>Media berita terpercaya untuk masyarakat Sumatera Utara. Menyajikan informasi terkini,
                            akurat, dan berimbang seputar Sumatera Utara.</p>
                        <div class="footer-social">
                            <a href="#" aria-label="Facebook"><svg xmlns="http://www.w3.org/2000/svg" width="18"
                                    height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" />
                                </svg></a>
                            <a href="#" aria-label="X"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                    viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
                                </svg></a>
                            <a href="#" aria-label="Instagram"><svg xmlns="http://www.w3.org/2000/svg" width="18"
                                    height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" />
                                </svg></a>
                            <a href="#" aria-label="YouTube"><svg xmlns="http://www.w3.org/2000/svg" width="18"
                                    height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z" />
                                </svg></a>
                        </div>
                    </div>
                    <div class="footer-column">
                        <h4 class="footer-title">Kategori</h4>
                        <ul class="footer-links">
                            <li><a href="../">Berita</a></li>
                            <li><a href="../?kategori=politik">Politik</a></li>
                            <li><a href="../?kategori=ekonomi">Ekonomi</a></li>
                            <li><a href="../?kategori=olahraga">Olahraga</a></li>
                            <li><a href="../?kategori=hiburan">Hiburan</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h4 class="footer-title">Layanan</h4>
                        <ul class="footer-links">
                            <li><a href="../../umkm/">UMKM</a></li>
                            <li><a href="../../event/">Event</a></li>
                            <li><a href="../../kirim-berita/">Kirim Berita</a></li>
                            <li><a href="../../kirim-event/">Kirim Event</a></li>
                            <li><a href="../../quiz/">Quiz Berita</a></li>
                            <li><a href="../../quiz/leaderboard/">Papan Peringkat</a></li>
                            <li><a href="#">Iklan</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h4 class="footer-title">Tentang</h4>
                        <ul class="footer-links">
                            <li><a href="../../tentang-kami/">Tentang Kami</a></li>
                            <li><a href="#">Redaksi</a></li>
                            <li><a href="#">Kontak</a></li>
                            <li><a href="#">Kebijakan Privasi</a></li>
                            <li><a href="#">Syarat & Ketentuan</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="container">
                <p>&copy; 2026 MarendalSatu. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="../../js/main.js"></script>
    <script src="../../js/auth.js"></script>
    <script type="module" src="../../js/firebase-comments.js"></script>
    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAAjCd2CvsfiRCVWcwNSmjNt_w3N4eVSbM",
            authDomain: "login-fe9bf.firebaseapp.com",
            databaseURL: "https://login-fe9bf-default-rtdb.firebaseio.com",
            projectId: "login-fe9bf"
        };

        let database;

        // Get news ID or slug from URL
        const urlParams = new URLSearchParams(window.location.search);
        const newsSlug = urlParams.get('slug');
        const newsId = urlParams.get('id'); // fallback untuk link lama

        function initFirebase() {
            return new Promise((resolve) => {
                const check = setInterval(() => {
                    if (typeof firebase !== 'undefined') {
                        clearInterval(check);
                        try {
                            let app;
                            try { app = firebase.app('detailApp'); }
                            catch (e) { app = firebase.initializeApp(firebaseConfig, 'detailApp'); }
                            database = app.database();
                            resolve();
                        } catch (err) {
                            console.error(err);
                            resolve();
                        }
                    }
                }, 100);
            });
        }

        async function loadNewsDetail() {
            const container = document.getElementById('articleMain');

            await initFirebase();

            // Search by slug or id
            if (newsSlug) {
                // Find news by slug
                database.ref('newsSubmissions').orderByChild('slug').equalTo(newsSlug).once('value', (snapshot) => {
                    let news = null;
                    snapshot.forEach((child) => {
                        news = child.val();
                    });

                    if (!news || news.status !== 'approved') {
                        showNotFound(container);
                        return;
                    }

                    renderNewsDetail(news);
                    loadRelatedNews(news.kategori, news.id);
                });
            } else if (newsId) {
                // Fallback: find by id (untuk link lama)
                database.ref('newsSubmissions/' + newsId).once('value', (snapshot) => {
                    const news = snapshot.val();

                    if (!news || news.status !== 'approved') {
                        showNotFound(container);
                        return;
                    }

                    renderNewsDetail(news);
                    loadRelatedNews(news.kategori, news.id);
                });
            } else {
                showNotFound(container);
            }
        }

        function showNotFound(container) {
            container.innerHTML = `
                <div class="article-not-found">
                    <h2>Berita Tidak Ditemukan</h2>
                    <p>Berita yang Anda cari tidak tersedia atau belum disetujui.</p>
                    <a href="../../berita/" class="btn-back">‚Üê Kembali ke Berita</a>
                </div>
            `;
        }

        function renderNewsDetail(news) {
            const container = document.getElementById('articleMain');

            // Update page title
            document.title = news.judul + ' - MarendalSatu';

            // Update breadcrumb
            const breadcrumbCategory = document.getElementById('breadcrumbCategory');
            if (breadcrumbCategory) {
                breadcrumbCategory.textContent = capitalize(news.kategori);
            }

            // Get images
            const images = Array.isArray(news.gambar) ? news.gambar : [news.gambar];
            const mediaTypes = news.mediaTypes || images.map(() => 'image');

            // Format date
            const tanggal = new Date(news.tanggal).toLocaleDateString('id-ID', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            container.innerHTML = `
                <div class="article-header">
                    <span class="article-category">${capitalize(news.kategori)}</span>
                    <h1 class="article-title">${escapeHtml(news.judul)}</h1>
                    <div class="article-meta">
                        <span>üìç ${escapeHtml(news.lokasi)}</span>
                        <span>üìÖ ${tanggal}</span>
                        <span>‚úçÔ∏è ${escapeHtml(news.penerbit)}</span>
                    </div>
                </div>

                <!-- Image/Video Gallery -->
                <div class="article-gallery">
                    <div class="gallery-main">
                        <span class="news-badge-user" style="position:absolute;top:15px;left:15px;z-index:5;">Kiriman Warga</span>
                        ${mediaTypes[0] === 'video' ?
                    `<video src="${images[0]}" autoplay muted loop playsinline id="mainMedia" style="width:100%;max-height:500px;"></video>` :
                    `<img src="${images[0]}" alt="${escapeHtml(news.judul)}" id="mainMedia">`
                }
                    </div>
                    ${images.length > 1 ? `
                        <div class="gallery-thumbs">
                            ${images.map((media, idx) => `
                                <div class="gallery-thumb ${idx === 0 ? 'active' : ''}" onclick="changeMainMedia(this, '${media}', '${mediaTypes[idx]}')">
                                    ${mediaTypes[idx] === 'video' ?
                        `<video src="${media}" muted style="width:100%;height:100%;object-fit:cover;"></video>` :
                        `<img src="${media}" alt="Foto ${idx + 1}">`
                    }
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <p class="image-caption">Dikirim oleh ${escapeHtml(news.penerbit)}</p>
                </div>

                <div class="article-content">
                    ${escapeHtml(news.deskripsi).split('\n').map(p => p.trim() ? `<p>${p}</p>` : '').join('')}
                </div>

                <div class="article-tags">
                    <span>Tags:</span>
                    <a href="../?kategori=${news.kategori}">${capitalize(news.kategori)}</a>
                </div>

                <div class="article-share">
                    <span>Bagikan:</span>
                    <div class="share-buttons">
                        <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}" target="_blank" class="share-btn-circle facebook" title="Facebook">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                        </a>
                        <a href="https://twitter.com/intent/tweet?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(news.judul)}" target="_blank" class="share-btn-circle twitter" title="X/Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                        </a>
                        <a href="https://wa.me/?text=${encodeURIComponent(news.judul + ' - ' + window.location.href)}" target="_blank" class="share-btn-circle whatsapp" title="WhatsApp">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                        </a>
                        <button type="button" class="share-btn-circle copy" title="Salin Link" onclick="copyLink()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                        </button>
                    </div>
                </div>
                
                <!-- Comments Section -->
                <div class="comments-section" id="commentsSection">
                    <h3>Komentar</h3>
                    <div id="commentsList" class="comments-list"></div>
                    <div id="commentForm" class="comment-form-container"></div>
                </div>
            `;

            // Load comments
            loadComments(news.id);
        }

        function loadComments(newsId) {
            const listContainer = document.getElementById('commentsList');
            const formContainer = document.getElementById('commentForm');

            // Check if user logged in
            const user = JSON.parse(localStorage.getItem('googleUser') || 'null');

            // Comment form
            if (user) {
                formContainer.innerHTML = `
                    <div class="comment-form">
                        <img src="${user.picture}" alt="${user.name}" class="comment-avatar">
                        <div class="comment-input-wrap">
                            <textarea id="commentInput" placeholder="Tulis komentar..." rows="2"></textarea>
                            <button type="button" onclick="submitComment('${newsId}')" class="btn-comment">Kirim</button>
                        </div>
                    </div>
                `;
            } else {
                formContainer.innerHTML = `
                    <div class="comment-login-prompt">
                        <p>üîê Silakan login untuk berkomentar</p>
                        <button type="button" class="btn-google-login" onclick="showLoginModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                            Login dengan Google
                        </button>
                    </div>
                `;
            }

            // Load comments from Firebase
            const commentsRef = database.ref('comments/' + newsId);
            commentsRef.on('value', (snapshot) => {
                const comments = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        comments.push({ id: child.key, ...child.val() });
                    });
                    comments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                }

                if (comments.length === 0) {
                    listContainer.innerHTML = '<p class="no-comments">Belum ada komentar. Jadilah yang pertama!</p>';
                } else {
                    listContainer.innerHTML = comments.map(c => `
                        <div class="comment-item">
                            <img src="${c.userPicture || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(c.userName)}" alt="" class="comment-avatar">
                            <div class="comment-body">
                                <div class="comment-header">
                                    <strong>${escapeHtml(c.userName)}</strong>
                                    <span>${timeAgo(c.createdAt)}</span>
                                </div>
                                <p>${escapeHtml(c.text)}</p>
                            </div>
                        </div>
                    `).join('');
                }
            });
        }

        window.submitComment = function (newsId) {
            const input = document.getElementById('commentInput');
            const text = input.value.trim();

            if (!text) {
                alert('Tulis komentar terlebih dahulu');
                return;
            }

            const user = JSON.parse(localStorage.getItem('googleUser'));
            if (!user) {
                alert('Silakan login terlebih dahulu');
                return;
            }

            const commentData = {
                text: text,
                userName: user.name,
                userEmail: user.email,
                userPicture: user.picture,
                userId: user.id,
                createdAt: new Date().toISOString()
            };

            database.ref('comments/' + newsId).push(commentData)
                .then(() => {
                    input.value = '';
                })
                .catch(err => {
                    alert('Gagal mengirim komentar: ' + err.message);
                });
        };

        function timeAgo(dateStr) {
            const now = new Date();
            const date = new Date(dateStr);
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'Baru saja';
            if (diff < 3600) return Math.floor(diff / 60) + ' menit lalu';
            if (diff < 86400) return Math.floor(diff / 3600) + ' jam lalu';
            if (diff < 604800) return Math.floor(diff / 86400) + ' hari lalu';
            return formatDate(dateStr);
        }

        function loadRelatedNews(kategori, currentId) {
            const container = document.getElementById('relatedNews');

            database.ref('newsSubmissions').once('value', (snapshot) => {
                const related = [];
                snapshot.forEach((child) => {
                    const news = child.val();
                    if (news.status === 'approved' && news.kategori === kategori && news.id !== currentId) {
                        related.push(news);
                    }
                });

                if (related.length === 0) return;

                container.innerHTML = related.slice(0, 3).map(news => {
                    const img = Array.isArray(news.gambar) ? news.gambar[0] : news.gambar;
                    const slug = news.slug || news.id;
                    return `
                        <div class="related-item">
                            <img src="${img}" alt="" onerror="this.src='https://placehold.co/80x60/eee/999?text=Img'">
                            <div class="related-content">
                                <h4><a href="./?slug=${slug}">${escapeHtml(news.judul)}</a></h4>
                                <span>${formatDate(news.tanggal)}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        function changeMainMedia(thumb, src, type) {
            const container = document.querySelector('.gallery-main');
            const badge = container.querySelector('.news-badge-user');

            if (type === 'video') {
                container.innerHTML = `<video src="${src}" autoplay muted loop playsinline id="mainMedia" style="width:100%;max-height:500px;"></video>`;
            } else {
                container.innerHTML = `<img src="${src}" alt="" id="mainMedia">`;
            }

            if (badge) container.insertBefore(badge, container.firstChild);

            document.querySelectorAll('.gallery-thumb').forEach(t => t.classList.remove('active'));
            thumb.classList.add('active');
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href);
            alert('Link berhasil disalin!');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function capitalize(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        // Load on page ready
        document.addEventListener('DOMContentLoaded', loadNewsDetail);
    </script>
    <script src="../../js/ai-chat.js"></script>
    <script src="../../js/visitor-counter.js" type="module"></script>
</body>

</html>